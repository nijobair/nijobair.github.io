(function(e){"object"==typeof exports&&"object"==typeof module?e(require("./codeMirror")):"function"==typeof define&&define.amd?define(["./codeMirror"],e):e(CodeMirror)})(function(e){function n(e,n){return"pairs"==n&&"string"==typeof e?e:"object"==typeof e&&null!=e[n]?e[n]:u[n]}function t(e){for(var n=0;n<e.length;n++){var t=e.charAt(n),i="'"+t+"'";p[i]||(p[i]=r(t))}}function r(e){return function(n){return c(n,e)}}function i(e){var n=e.state.closeBrackets;if(!n||n.override)return n;var t=e.getModeAt(e.getCursor());return t.closeBrackets||n}function a(t){var r=i(t);if(!r||t.getOption("disableInput"))return e.Pass;for(var a=n(r,"pairs"),o=t.listSelections(),s=0;s<o.length;s++){if(!o[s].empty())return e.Pass;var l=f(t,o[s].head);if(!l||a.indexOf(l)%2!=0)return e.Pass}for(s=o.length-1;s>=0;s--){var c=o[s].head;t.replaceRange("",d(c.line,c.ch-1),d(c.line,c.ch+1),"+delete")}}function o(t){var r=i(t),a=r&&n(r,"explode");if(!a||t.getOption("disableInput"))return e.Pass;for(var o=t.listSelections(),l=0;l<o.length;l++){if(!o[l].empty())return e.Pass;var c=f(t,o[l].head);if(!c||a.indexOf(c)%2!=0)return e.Pass}t.operation(function(){var e=t.lineSeparator()||"\n",n=t.getOption("indentWithTabs")?"\t":Array(t.getOption("indentUnit")+1).join(" ");t.replaceSelection(e+n+e,null),s(t,-1),o=t.listSelections();for(var r=0;r<o.length;r++){var i=o[r].head.line;t.indentLine(i,null,!0),t.indentLine(i+1,null,!0)}})}function s(e,n){for(var t=[],r=e.listSelections(),i=0,a=0;a<r.length;a++){var o=r[a];o.head==e.getCursor()&&(i=a);var s=o.head.ch||n>0?{line:o.head.line,ch:o.head.ch+n}:{line:o.head.line-1};t.push({anchor:s,head:s})}e.setSelections(t,i)}function l(n){var t=e.cmpPos(n.anchor,n.head)>0;return{anchor:new d(n.anchor.line,n.anchor.ch+(t?-1:1)),head:new d(n.head.line,n.head.ch+(t?1:-1))}}function c(t,r){var a=i(t);if(!a||t.getOption("disableInput"))return e.Pass;var o=n(a,"pairs"),c=o.indexOf(r);if(-1==c)return e.Pass;for(var f,u=n(a,"closeBefore"),p=n(a,"triples"),g=o.charAt(c+1)==r,v=t.listSelections(),b=c%2==0,y=0;y<v.length;y++){var P,S=v[y],k=S.head,O=t.getRange(k,d(k.line,k.ch+1));if(b&&!S.empty())P="surround";else if(!g&&b||O!=r)if(g&&k.ch>1&&p.indexOf(r)>=0&&t.getRange(d(k.line,k.ch-2),k)==r+r){if(k.ch>2&&/\bstring/.test(t.getTokenTypeAt(d(k.line,k.ch-2))))return e.Pass;P="addFour"}else if(g){var x=0==k.ch?" ":t.getRange(d(k.line,k.ch-1),k);if(e.isWordChar(O)||x==r||e.isWordChar(x))return e.Pass;P="both"}else{if(!b||!(0===O.length||/\s/.test(O)||u.indexOf(O)>-1))return e.Pass;P="both"}else P=g&&h(t,k)?"both":p.indexOf(r)>=0&&t.getRange(k,d(k.line,k.ch+3))==r+r+r?"skipThree":"skip";if(f){if(f!=P)return e.Pass}else f=P}var A=c%2?o.charAt(c-1):r,B=c%2?r:o.charAt(c+1);t.operation(function(){if("skip"==f)s(t,1);else if("skipThree"==f)s(t,3);else if("surround"==f){for(var e=t.getSelections(),n=0;n<e.length;n++)e[n]=A+e[n]+B;t.replaceSelections(e,"around"),e=t.listSelections().slice();for(n=0;n<e.length;n++)e[n]=l(e[n]);t.setSelections(e)}else"both"==f?(t.replaceSelection(A+B,null),t.triggerElectric(A+B),s(t,-1)):"addFour"==f&&(t.replaceSelection(A+A+A+A,"before"),s(t,1))})}function f(e,n){var t=e.getRange(d(n.line,n.ch-1),d(n.line,n.ch+1));return 2==t.length?t:null}function h(e,n){var t=e.getTokenAt(d(n.line,n.ch+1));return/\bstring/.test(t.type)&&t.start==n.ch&&(0==n.ch||!/\bstring/.test(e.getTokenTypeAt(n)))}var u={pairs:"()[]{}''\"\"",closeBefore:")]}'\":;>",triples:"",explode:"[]{}()"},d=e.Pos;e.defineOption("autoCloseBrackets",!1,function(r,i,a){a&&a!=e.Init&&(r.removeKeyMap(p),r.state.closeBrackets=null),i&&(t(n(i,"pairs")),r.state.closeBrackets=i,r.addKeyMap(p))});var p={Backspace:a,Enter:o};t(u.pairs+"`")});